<!DOCTYPE html><html lang="zh-TW"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>SLMT's Blog | 漏洞筆記 - 別讓你的 .git 資料夾公開在網路上啊！</title><link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="stylesheet" type="text/css" href="/css/syntax-highlight.css"><script src="https://use.fontawesome.com/0bc11e7eba.js"></script><!-- Open Graph Protocol--><meta property="og:title" content="漏洞筆記 - 別讓你的 .git 資料夾公開在網路上啊！"><meta property="og:image" content="http://www.slmt.tw/images/logo.png"><meta property="og:type" content="website"><meta property="og:url" content="/2016/08/22/dont-expose-your-git-dir/"><meta property="og:site_name" content="SLMT's Blog"><meta property="og:locale" content="zh-TW"><meta property="og:description" content="這個周末玩了一個 CTF 線上賽。其中有一題是說有一個新手架了一個網站，然後分別使用了 Nginx、PHP、git 這些技術。點開題目提供的網址後，就看到一個 Hello World 的網頁。打開原始碼後，只看到幾行簡單的基礎程式碼，也沒有看到可疑的東西。正當我打算要放棄的時候，突然想到題目有特別提到他有使用 git。於是就嘗試了打開該網站的 .git 資料夾，不過馬上就被 403 Forbidden 打臉。
就在我快想不到到底怎麼辦的時候，突然又靈機一動。想到雖然我看不到 .git 的內容，但或許我仍可以下載裡面的檔案？於是我馬上隨便打開我手邊的一個 git repository。發現 .git 資料夾內一定有 HEAD 這個檔案。於是我馬上就嘗試下載 .git/HEAD。果不其然！可以抓到這個檔案！那麼接下來就有個方向了！"></head><body><div id="container"><div id="header"><h1 class="title">SLMT's Blog</h1><div class="pure-g navs"><div class="nav pure-u-1 pure-u-sm-1-4"><a href="/.">Home</a></div><div class="nav pure-u-1 pure-u-sm-1-4"><a href="/archives">Archive</a></div><div class="nav pure-u-1 pure-u-sm-1-4"><a href="/about">About</a></div><div class="nav pure-u-1 pure-u-sm-1-4"><a href="/rss.xml">RSS</a></div></div></div><div id="main"><h1 class="post-large-title">漏洞筆記 - 別讓你的 .git 資料夾公開在網路上啊！</h1><div class="post-meta"><div class="post-date"><i class="fa fa-calendar" aria-hidden="true"></i>2016/08/22</div><div class="post-cats"><i class="fa fa-folder-open" aria-hidden="true"></i><a class="post-cat" href="/categories/hacking/">Hacking</a>/<a class="post-cat" href="/categories/hacking/exploit/">Exploit</a></div><div class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a class="post-tag" href="/tags/hacking/">#hacking</a><a class="post-tag" href="/tags/web/">#web</a><a class="post-tag" href="/tags/exploit/">#exploit</a><a class="post-tag" href="/tags/git/">#git</a></div></div><div class="post-content"><p>這個周末玩了一個 CTF 線上賽。其中有一題是說有一個新手架了一個網站，然後分別使用了 Nginx、PHP、git 這些技術。點開題目提供的網址後，就看到一個 Hello World 的網頁。打開原始碼後，只看到幾行簡單的基礎程式碼，也沒有看到可疑的東西。正當我打算要放棄的時候，突然想到題目有特別提到他有使用 git。於是就嘗試了打開該網站的 <code>.git</code> 資料夾，不過馬上就被 403 Forbidden 打臉。</p>
<p>就在我快想不到到底怎麼辦的時候，突然又靈機一動。想到雖然我看不到 <code>.git</code> 的內容，但或許我仍可以下載裡面的檔案？於是我馬上隨便打開我手邊的一個 git repository。發現 <code>.git</code> 資料夾內一定有 <code>HEAD</code> 這個檔案。於是我馬上就嘗試下載 <code>.git/HEAD</code>。果不其然！可以抓到這個檔案！那麼接下來就有個方向了！</p>
<a id="more"></a>
<h2 id="git-資料夾"><a href="#git-資料夾" class="headerlink" title=".git 資料夾"></a><code>.git</code> 資料夾</h2><p>稍微研究了一下，一個 <code>.git</code> 的資料夾大概有 <code>hooks</code>、<code>info</code>、<code>logs</code>、<code>objects</code>、<code>refs</code>，檔案則大概有 <code>COMMIT_EDITMSG</code>、<code>config</code>、<code>description</code>、<code>HEAD</code>。</p>
<p>其中 <code>hooks</code>、<code>info</code> 這兩個資料夾在大多數的 <code>.git</code> 之中都沒有甚麼有用的資訊，<code>logs</code> 則是其中可以馬上看出最多資訊的資料夾。<code>objects</code> 則存著所有版本的 binary 檔，裡面的東西乍看之下沒有甚麼規則，於是我先跳過。<code>refs</code> 則存放每個 branch 目前指向的 commit 為何。</p>
<p>除了 <code>objects</code> 以外，所有檔案的檔名大多可以猜到，因此我就將這些檔案抓了下來。可惜裡面最多只能從 log 中看出曾經有 commit 過含有 flag 的檔案。但是檔案的實際內容就無從得知了。</p>
<h2 id="Git-Objects"><a href="#Git-Objects" class="headerlink" title="Git Objects"></a>Git Objects</h2><p>我發現我似乎最後仍得要還原出每個版本，才有辦法解出這題。因此我開始研究了 <code>objects</code> 內的內容。後來稍微思考了一下，覺得 git 官方應該會有相關的文件。Google 一下很快就有發現了！果然有關於內部運作邏輯的文件，甚至連 objects 的存放方式跟意義都有明確說明。甚至還有繁體中文版！文件有興趣的可以參考看看：</p>
<p><a href="https://git-scm.com/book/zh-tw/v1/Git-%E5%85%A7%E9%83%A8%E5%8E%9F%E7%90%86" target="_blank" rel="external">https://git-scm.com/book/zh-tw/v1/Git-%E5%85%A7%E9%83%A8%E5%8E%9F%E7%90%86</a></p>
<p>大略看過之後，才知道原來所有的 commit 的文件都會獨立存成一個檔案。每個檔案會先計算 SHA1 值為多少，然後取前兩碼做為 <code>objects</code> 內的資料夾名稱，後 38 碼則做為 <code>objects</code> 內部的檔名存放。在 <code>objects</code> 中，除了存放 commit 的檔案外，還會存放 commit 時的目錄結構 (稱為 tree)，以及 commit 的紀錄。這些也同樣會用上述的方式存起來。目錄會紀錄裡面包含的其他目錄以及檔案的 SHA1 值為何。Commit 紀錄則會有該次 commit 對應的目錄 SHA1 值，以及上一次 commit 的 SHA1 值。</p>
<p>這些檔案都被以 binary 的方式存起來。我稍微查了一下有沒有簡便的方法可以直接看到內容。果不其然，可以透過 <code>git cat-file</code> 指令解碼 objects 的內容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git cat-file -p [SHA1]</div></pre></td></tr></table></figure>
<p><code>[SHA1]</code> 處要填上你想要解碼的 object 檔的 SHA1 值，有興趣的人可以自己試試看。記住 SHA1 前兩碼是資料夾名稱，後 38 碼是檔案名稱。</p>
<h2 id="檢查指令"><a href="#檢查指令" class="headerlink" title="檢查指令"></a>檢查指令</h2><p>在得知這些資訊後，我馬上去查看 log 檔，找到 commit 的 SHA1 值，然後嘗試去下載對應的 object 檔。一試之後，馬上就成功下載對應的檔案。我接著立刻用查到的指令解碼，就看到了類似下列的內容：(這個內容是我拿我的部落格 git 資料夾 demo)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">tree 9aa33d38927cdde7b969586a2a7e942d816ea947</div><div class="line">parent bfd06e73e40a78720418795cacc3072bad168d85</div><div class="line">author slmt &lt;sam123456777@gmail.com&gt; 1471021607 +0800</div><div class="line">committer slmt &lt;sam123456777@gmail.com&gt; 1471021607 +0800</div><div class="line"></div><div class="line">Add a new post</div></pre></td></tr></table></figure>
<p><code>tree</code> 指的就是該次 commit 對應的目錄檔，<code>parent</code> 指的是上一次 commit 的 SHA1 值。其他則是容易辨別的 commit 資料。</p>
<p>我馬上就知道我又獲得了兩個 SHA1，所以就繼續使用這些 SHA1 下載對應的 object 檔。只是多試幾次之後，很快就感到厭煩了。因為你要先解碼，還要看哪一個是沒有抓過的。全部抓下來的話很花時間。</p>
<p>幸好我後來又發現另一個指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git fsck</div></pre></td></tr></table></figure>
<p>這個指令會檢查你的 objects 檔之間的 link 是否完整，並且會找出應該存在但是找不到的 object 檔。這個指令大大地幫助我減少檢查檔案的時間。於是我很快就把遺失的 object 檔補齊。找到所有 object 檔後，很輕易地就使用常用的 git 指令找出了之前的版本，然後發現題目要求的 flag。順利解決。</p>
<h2 id="下載-Script"><a href="#下載-Script" class="headerlink" title="下載 Script"></a>下載 Script</h2><p>寫完這題之後，我覺得雖然有 <code>git fsck</code> 幫助，但是一一下載檔案仍然非常麻煩。因此我就寫了一個 python script 來幫助我進行自動下載。該 script 可以在這裡找到：</p>
<p><a href="https://github.com/SLMT/ctf-tools/tree/master/git-repository-downloader" target="_blank" rel="external">https://github.com/SLMT/ctf-tools/tree/master/git-repository-downloader</a></p>
<p>基本上 script 就是做我前列提到的那些事情，只是變成只要輸入一個指令就可以完成所有動作。</p>
<h2 id="呼籲"><a href="#呼籲" class="headerlink" title="呼籲"></a>呼籲</h2><p>最後呼籲一下。別忘記這題會被解開是因為 <code>.git</code> 的下載權限被設為公開。若之後大家在開發網站，別忘記把 <code>.git</code> 的下載權限關掉。只有關掉閱讀目錄的權限還遠遠不夠，只要使用我的 script 就可以完整地復原整個 git repository XD 因此真的要很小心~~!!!</p>
</div><div id="disqus_thread"><script>var disqus_shortname = 'slmtsblog';
var disqus_identifier = '2016/08/22/dont-expose-your-git-dir/';
var disqus_title = '漏洞筆記 - 別讓你的 .git 資料夾公開在網路上啊！';
var disqus_url = 'http://www.slmt.tw/2016/08/22/dont-expose-your-git-dir/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></div></div><div id="footer"><p>&copy; Yu-shan Lin (SLMT) and SLMT's Blog, 2016</p></div></div></body></html>